{% extends "base.html" %}
{% load static %}

{% block page_title %}Chat{% endblock  %}

{% block page_css_files %}
<link rel="stylesheet" href="{% static "chat/chat.css" %}">
<link rel="stylesheet" href={% static "chat/chat_additional.css" %}>
{{ request.user.username|json_script:"request-user" }}
{{ request.user.id|json_script:"request-user-id" }}
{% endblock  %}

{% block page_content %}


<div class="main-window">

            <nav class="navbar navbar-light bg-light">
              <div class="container-fluid">
                <a class="navbar-brand" href="/">Navbar</a>

                
                <form id="search-form" method="POST" class="search-form d-flex" autocomplete="off">
                  {% csrf_token %}
                  <input id="search-friend" name="search-friend" class="search-input form-control" type="search" placeholder="Search" aria-label="Search" >
                  <button class="search-button btn" type="submit"><i data-bs-toggle="modal" data-bs-target="#modalUsers" class="bi bi-search"></i></button>
                  <ul id="search-results" class="dropdown-menu mt-5 rounded"></ul>
                </form>

                  
                <div class="text-center">
                  {% if request.user in all_tmp_users %}

                  <p class="fw-light">You are temporary user, please make <a href="{% url "convert" %}">account</a></p>
                  {% endif %}
                </div>

                <div class="dropstart">
                  <p class="fw-bold" type="button" id="dropdownMenuUser" data-bs-toggle="dropdown" aria-expanded="false"><i id="user-status-icon" class="bi bi-chat-dots-fill"></i> {{request.user}}</p>
                  
                  <ul class="dropdown-menu" aria-labelledby="dropdownMenuUser">
                    <li>
                      
                      <a class="dropdown-item" id="user-status" href="#" name="user-status-toggle">
                      {% comment %} <script id="user-status-icon-{{user.username}}" type="application/json">true</script> {% endcomment %}
                        {{ user.online|json_script:"user-current-status" }}
                        {% if user.online %}
                        Set status Offline
                        {% else %}
                        Set status Online
                        {% endif %}
                      </a>
                    </li>
                  {% comment %}                     
                    {% if user.is_active %}
                      <li><a class="dropdown-item" id="user-status" href="#" name="user-offline">Set status Offline</a></li>
                    {% else %} 
                      <li><a class="dropdown-item" id="user-status" href="#" name="user-online">Set status Online</a></li>
                    {% endif %} {% endcomment %}

                  </ul>
                </div>

              </div>
            </nav>

            <section class="main-section overflow-hidden border-top border-4">
              
                          <main>
                              
                            <div class="d-flex flex-column flex-shrink-0 left-panel">
                                  <h5 class="mb-3 text-center card-header">Channels</h5>
                                    <div class="card-body">
                                          <div id="chat-lists">
                                            <ul class="list-unstyled mb-0" id="chat-list">
                                              {% for room in all_rooms %}
                                                  <li class="chats" onclick="return createSocket(this);" > 
                                                     <a id="room-name" class="friend-link" class="d-flex justify-content-between">
                                                      <div class="d-flex justify-content-between">
                                                          <p class="mb-0" >{{room.name}}</p>
                                                      </div>
                                                    </a>
                                                  </li>
                                              {% endfor %}
                                            </ul>
                                          </div>
                                      <hr>
                                    </div>
                                  <!-- Button trigger modal -->
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNewChannel">
                                  Create new channel
                                </button>
                            </div>
                        
                            <div class="chat-window">
                              <div class="load-chat-window"id="loadChat"></div>
                            </div>

                            <div class="friends-list bg-light p-1 rounded">

                              <p class="text-center">Friends</p>
                              <hr>

                                  <ul id="friends" class="friends list-unstyled d-flex flex-column">
                                    {% for friends in friends_room %}
                                    <li class="chats-friends" data-value="{{friends.default}}" onclick="return createSocketWithUser(this);"> 
                                      <a id="room-name" class="room-link" class="d-flex justify-content-between">
                                        <div class="d-flex justify-content-between">
                                            <p class="mb-0">
                                              {% if friends.author == request.user %}
                                                {{friends.friend}} <i id="user-status-icon-{{friends.friend}}" 
                                                data-value-status="{{friends.friend.online}}" 
                                                data-value-nickname="{{friends.friend}}" class="bi bi-chat-dots-fill"></i>
                                              {% else %}
                                                {{friends.author}} <i id="user-status-icon-{{friends.author}}" 
                                                data-value-status="{{friends.author.online}}" 
                                                data-value-nickname="{{friends.author}}" class="bi bi-chat-dots-fill"></i>
                                              {% endif %}</p>

                                        </div> 
                                      </a>
                                    </li>
                                    {%empty%}
                                    {% endfor %}
                                  </ul>

                            </div>
                          </main>
                  
              </section>

</div>


          <!-- Modal -->
          <div class="modal fade" id="createNewChannel" tabindex="-1" aria-labelledby="createNewChannelLabel" aria-hidden="true" data-bs-backdrop="false">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="createNewChannelLabel">Create new channel</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">


                      <div class="create-form">
                        <form id="create-new-channel" method="POST">
                          {% csrf_token %}
                          <div class="row justify-content-md-center">
                              <div class="col-md-auto">
                                <input class="form-control" id="room-name-input" type="text" name="room-name-input" size="30">
                              </div>
                          </div>
                      </div>
                    
                
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          <button class="form-label btn btn-info btn-rounded" id="room-name-submit" onclick="createNewChannel(event)">Create</button>
                        </div>
                      </form>
                </div>
              </div>
            </div>



<script src={% static "chat/get-csrf.js" %}></script>
<script src={% static "chat/room-search.js" %}></script>
<script src={% static "chat/room.js" %}></script>
<script src={% static "chat/room-directmessage.js" %}></script>
<script src={% static "chat/user-status.js" %}></script>
<script src={% static "chat/main-socket.js" %}></script>



{% if friends.author == request.user %}
{{friends.friend}} <i id="user-status-icon-{{friends.friend}}" 
data-value-status="{{friends.friend.online}}" 
data-value-nickname="{{friends.friend}}" class="bi bi-chat-dots-fill"></i>
{% else %}
{{friends.author}} <i id="user-status-icon-{{friends.author}}" 
data-value-status="{{friends.author.online}}" 
data-value-nickname="{{friends.author}}" class="bi bi-chat-dots-fill"></i>
{% endif %}</p>


<script>

  let tmpFriendsList = [
    {% for friends in friends_room %}
      {% if friends.author == request.user %}
        {
          nickname: "{{ friends.friend }}",
          status: "{{ friends.friend.online }}",
        },
        
      {% else %}
        {
          nickname: "{{ friends.author }}",
          status: "{{ friends.author.online }}",
        },
      {% endif %}
    {% endfor %}
  ];

  
  tmpFriendsList.forEach(function(friend) {
    console.log(friend.status)
    updateElementFriend(friend.nickname, friend.status.toLowerCase());
  });

</script>



{% endblock  %}
